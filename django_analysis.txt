–ê–†–•–ò–¢–ï–ö–¢–£–†–ê DJANGO –ü–†–û–ï–ö–¢–ê:
==================================================
üìÅ –ö–û–†–ï–ù–¨ –ü–†–û–ï–ö–¢–ê:
‚îú‚îÄ‚îÄ manage.py
‚îú‚îÄ‚îÄ requirements.txt

üìÅ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø:
‚îú‚îÄ‚îÄ config\/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ asgi.py
‚îÇ   ‚îú‚îÄ‚îÄ celery.py
‚îÇ   ‚îú‚îÄ‚îÄ settings.py
‚îÇ   ‚îú‚îÄ‚îÄ urls.py
‚îÇ   ‚îú‚îÄ‚îÄ wsgi.py
‚îú‚îÄ‚îÄ main\/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ admin.py
‚îÇ   ‚îú‚îÄ‚îÄ apps.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îú‚îÄ‚îÄ serializers.py
‚îÇ   ‚îú‚îÄ‚îÄ services.py
‚îÇ   ‚îú‚îÄ‚îÄ tasks.py
‚îÇ   ‚îú‚îÄ‚îÄ tests.py
‚îÇ   ‚îú‚îÄ‚îÄ urls.py
‚îÇ   ‚îú‚îÄ‚îÄ views.py

üìÅ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø:
‚îú‚îÄ‚îÄ main\/
‚îÇ   ‚îú‚îÄ‚îÄ admin.py
‚îÇ   ‚îú‚îÄ‚îÄ apps.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îú‚îÄ‚îÄ serializers.py
‚îÇ   ‚îú‚îÄ‚îÄ tasks.py
‚îÇ   ‚îú‚îÄ‚îÄ tests.py
‚îÇ   ‚îú‚îÄ‚îÄ urls.py
‚îÇ   ‚îú‚îÄ‚îÄ views.py
‚îÇ   ‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 0001_initial.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py

============================================================

–°–û–î–ï–†–ñ–ò–ú–û–ï –í–ê–ñ–ù–´–• –§–ê–ô–õ–û–í:
============================================================

üöÄ –§–ê–ô–õ: config\celery.py
----------------------------------------
# celery.py
from __future__ import absolute_import, unicode_literals
import os
from celery import Celery
from celery.schedules import crontab

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'your_project.settings')

app = Celery('your_project')
app.config_from_object('django.conf:settings', namespace='CELERY')
app.autodiscover_tasks()

# –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
app.conf.beat_schedule = {
    'check-giveaways-every-minute': {
        'task': 'giveaway.tasks.check_scheduled_giveaways',
        'schedule': crontab(minute='*'),
    },
}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üöÄ –§–ê–ô–õ: config\settings.py
----------------------------------------
import os
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = os.environ.get('django-insecure-x)sl$d+ny0xn0dhs@9+3^(5718&dzm*w)0#!oneucuwf7#dlx*', 'your-secret-key-change-in-production')
DEBUG = os.environ.get('DEBUG', 'False') == 'True'

ALLOWED_HOSTS = [
    'kakos.pythonanywhere.com',
    'localhost',
    '127.0.0.1'
]

# Apps —Ç–æ–ª—å–∫–æ –¥–ª—è API
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # Third party
    'rest_framework',
    'rest_framework.authtoken',
    'corsheaders',
    
    # Local
    'main',
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'config.urls'

# –£–±–∏—Ä–∞–µ–º TEMPLATES –∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}



REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.TokenAuthentication',
        'rest_framework.authentication.SessionAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
        'rest_framework.renderers.BrowsableAPIRenderer',
    ],
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20,
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ]
}

# CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
CORS_ALLOW_ALL_ORIGINS = False
CORS_ALLOWED_ORIGINS = [
    "https://your-frontend-domain.com",  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
    "http://localhost:3000",
    "http://127.0.0.1:3000",
]

CORS_ALLOW_METHODS = [
    'DELETE',
    'GET',
    'OPTIONS',
    'PATCH',
    'POST',
    'PUT',
]

CORS_ALLOW_HEADERS = [
    'accept',
    'accept-encoding',
    'authorization',
    'content-type',
    'dnt',
    'origin',
    'user-agent',
    'x-csrf-token',
    'x-requested-with',
]

# –î–ª—è PythonAnywhere –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
CELERY_TASK_ALWAYS_EAGER = True
CELERY_TASK_EAGER_PROPAGATES = True

LANGUAGE_CODE = 'ru-ru'
TIME_ZONE = 'Europe/Moscow'
USE_I18N = True
USE_TZ = True

STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'

MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': BASE_DIR / 'django.log',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file'],
            'level': 'INFO',
            'propagate': True,
        },
    },
}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üöÄ –§–ê–ô–õ: config\urls.py
----------------------------------------
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include('main.urls')),
    path('api/auth/', include('rest_framework.urls')),
    
    # –ü—Ä–æ—Å—Ç–∞—è –∫–æ—Ä–Ω–µ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± API
    path('', include('main.urls')),  # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ API
]

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üöÄ –§–ê–ô–õ: main\admin.py
----------------------------------------
from django.contrib import admin
from .models import Giveaway, Participant, Winner

@admin.register(Giveaway)
class GiveawayAdmin(admin.ModelAdmin):
    list_display = ['title', 'join_code', 'draw_time', 'is_active', 'created_by']
    list_filter = ['is_active', 'draw_time']
    search_fields = ['title', 'join_code']

@admin.register(Participant)
class ParticipantAdmin(admin.ModelAdmin):
    list_display = ['user', 'giveaway', 'joined_at']
    list_filter = ['giveaway', 'joined_at']

@admin.register(Winner)
class WinnerAdmin(admin.ModelAdmin):
    list_display = ['participant', 'giveaway', 'won_at']
    list_filter = ['giveaway', 'won_at']

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üöÄ –§–ê–ô–õ: main\apps.py
----------------------------------------
from django.apps import AppConfig


class MainConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'main'

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üöÄ –§–ê–ô–õ: main\models.py
----------------------------------------
# models.py
from django.contrib.auth.models import User
from django.db import models

class Giveaway(models.Model):
    title = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    join_code = models.CharField(max_length=20, unique=True)  # –ö–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞
    max_participants = models.PositiveIntegerField(null=True, blank=True)  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    draw_time = models.DateTimeField()  # –í—Ä–µ–º—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞
    is_active = models.BooleanField(default=True)
    created_by = models.ForeignKey(User, on_delete=models.CASCADE, related_name='created_giveaways')
    created_at = models.DateTimeField(auto_now_add=True)
    winners_count = models.PositiveIntegerField(default=1)  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
    
    def __str__(self):
        return self.title

class Participant(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='participations')
    giveaway = models.ForeignKey(Giveaway, on_delete=models.CASCADE, related_name='participants')
    joined_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        unique_together = ['user', 'giveaway']  # –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å

class Winner(models.Model):
    participant = models.ForeignKey(Participant, on_delete=models.CASCADE, related_name='wins')
    giveaway = models.ForeignKey(Giveaway, on_delete=models.CASCADE, related_name='winners')
    won_at = models.DateTimeField(auto_now_add=True)
    prize_description = models.TextField(blank=True)
    
    class Meta:
        unique_together = ['participant', 'giveaway']

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üöÄ –§–ê–ô–õ: main\serializers.py
----------------------------------------
# serializers.py
from rest_framework import serializers
from django.contrib.auth.models import User
from .models import Giveaway, Participant, Winner

class UserSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ['id', 'username', 'email']

class GiveawaySerializer(serializers.ModelSerializer):
    created_by = UserSerializer(read_only=True)
    participants_count = serializers.SerializerMethodField()
    is_joined = serializers.SerializerMethodField()
    is_creator = serializers.SerializerMethodField()
    
    class Meta:
        model = Giveaway
        fields = '__all__'
    
    def get_participants_count(self, obj):
        return obj.participants.count()
    
    def get_is_joined(self, obj):
        request = self.context.get('request')
        if request and request.user.is_authenticated:
            return obj.participants.filter(user=request.user).exists()
        return False
    
    def get_is_creator(self, obj):
        request = self.context.get('request')
        if request and request.user.is_authenticated:
            return obj.created_by == request.user
        return False

class ParticipantSerializer(serializers.ModelSerializer):
    user = UserSerializer(read_only=True)
    
    class Meta:
        model = Participant
        fields = '__all__'

class WinnerSerializer(serializers.ModelSerializer):
    participant = ParticipantSerializer(read_only=True)
    
    class Meta:
        model = Winner
        fields = '__all__'


class UserRegistrationSerializer(serializers.ModelSerializer):
    password = serializers.CharField(write_only=True, min_length=8)
    password_confirm = serializers.CharField(write_only=True)
    
    class Meta:
        model = User
        fields = ['username', 'email', 'password', 'password_confirm']
    
    def validate(self, attrs):
        if attrs['password'] != attrs['password_confirm']:
            raise serializers.ValidationError("Passwords don't match")
        return attrs
    
    def create(self, validated_data):
        validated_data.pop('password_confirm')
        user = User.objects.create_user(
            username=validated_data['username'],
            email=validated_data.get('email', ''),
            password=validated_data['password']
        )
        return user

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üöÄ –§–ê–ô–õ: main\tasks.py
----------------------------------------
from celery import shared_task
from django.utils import timezone
from django.db import transaction
from .models import Giveaway, Participant, Winner
import random

@shared_task
def schedule_giveaway_draw(giveaway_id):
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞"""
    try:
        giveaway = Giveaway.objects.get(id=giveaway_id)
        
        with transaction.atomic():
            participants = list(giveaway.participants.all())
            
            if not participants:
                return "–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞"
            
            # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä
            winners_count = min(giveaway.winners_count, len(participants))
            winners = random.sample(participants, winners_count)
            
            # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
            for participant in winners:
                Winner.objects.create(
                    participant=participant,
                    giveaway=giveaway
                )
            
            # –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è
            giveaway.is_active = False
            giveaway.save()
        
        return f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–æ {len(winners)} –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π"
    
    except Giveaway.DoesNotExist:
        return "–†–æ–∑—ã–≥—Ä—ã—à –Ω–µ –Ω–∞–π–¥–µ–Ω"

@shared_task
def check_scheduled_giveaways():
    """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é"""
    now = timezone.now()
    active_giveaways = Giveaway.objects.filter(
        is_active=True,
        draw_time__lte=now
    )
    
    for giveaway in active_giveaways:
        schedule_giveaway_draw.delay(giveaway.id)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üöÄ –§–ê–ô–õ: main\urls.py
----------------------------------------
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import GiveawayViewSet, MyParticipationsViewSet, CustomAuthToken, UserRegistrationView
from django.http import JsonResponse

def api_root(request):
    """–ü—Ä–æ—Å—Ç–∞—è –∫–æ—Ä–Ω–µ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ API"""
    return JsonResponse({
        'message': 'Giveaway Service API',
        'endpoints': {
            'register': '/api/auth/register/',
            'login': '/api/auth/token/',
            'giveaways': '/api/giveaways/',
            'my_participations': '/api/my-participations/',
            'admin': '/admin/'
        }
    })

router = DefaultRouter()
router.register(r'giveaways', GiveawayViewSet, basename='giveaway')
router.register(r'my-participations', MyParticipationsViewSet, basename='myparticipations')

urlpatterns = [
    path('', api_root, name='api-root'),
    path('', include(router.urls)),
    path('auth/register/', UserRegistrationView.as_view(), name='register'),
    path('auth/token/', CustomAuthToken.as_view(), name='api_token_auth'),
]

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üöÄ –§–ê–ô–õ: main\views.py
----------------------------------------
# views.py
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.utils import timezone
from .models import Giveaway, Participant, Winner
from .serializers import GiveawaySerializer, ParticipantSerializer, WinnerSerializer
from .tasks import schedule_giveaway_draw
from rest_framework.authtoken.views import ObtainAuthToken
from rest_framework.authtoken.models import Token
from rest_framework.response import Response

from rest_framework import generics, status
from rest_framework.response import Response
from django.contrib.auth.models import User
from .serializers import UserRegistrationSerializer


class UserRegistrationView(generics.CreateAPIView):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    queryset = User.objects.all()
    serializer_class = UserRegistrationSerializer
    permission_classes = []  # –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    
    def create(self, request, *args, **kwargs):
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        user = serializer.save()
        
        # –°–æ–∑–¥–∞–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        from rest_framework.authtoken.models import Token
        token, created = Token.objects.get_or_create(user=user)
        
        return Response({
            'token': token.key,
            'user_id': user.pk,
            'username': user.username,
            'email': user.email,
            'message': 'User created successfully'
        }, status=status.HTTP_201_CREATED)
    

class CustomAuthToken(ObtainAuthToken):
    def post(self, request, *args, **kwargs):
        serializer = self.serializer_class(data=request.data,
                                           context={'request': request})
        serializer.is_valid(raise_exception=True)
        user = serializer.validated_data['user']
        token, created = Token.objects.get_or_create(user=user)
        return Response({
            'token': token.key,
            'user_id': user.pk,
            'username': user.username,
            'email': user.email
        })
    
    
class GiveawayViewSet(viewsets.ModelViewSet):
    serializer_class = GiveawaySerializer
    permission_classes = [IsAuthenticated]
    
    # –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ê–¢–†–ò–ë–£–¢:
    queryset = Giveaway.objects.all()
    
    def get_queryset(self):
        # –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—ã –≤–∏–¥—è—Ç —Å–≤–æ–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∏, –∏–≥—Ä–æ–∫–∏ - –∞–∫—Ç–∏–≤–Ω—ã–µ
        if self.request.query_params.get('my_giveaways'):
            return Giveaway.objects.filter(created_by=self.request.user)
        return Giveaway.objects.filter(is_active=True)
    
    def perform_create(self, serializer):
        serializer.save(created_by=self.request.user)
    
    @action(detail=True, methods=['post'])
    def enter(self, request, pk=None):
        """–£—á–∞—Å—Ç–∏–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ –ø–æ –∫–æ–¥—É"""
        giveaway = self.get_object()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        if giveaway.participants.filter(user=request.user).exists():
            return Response(
                {'error': '–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —ç—Ç–æ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        if giveaway.max_participants and giveaway.participants.count() >= giveaway.max_participants:
            return Response(
                {'error': '–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        if giveaway.draw_time < timezone.now():
            return Response(
                {'error': '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Ä–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à–µ–Ω–∞'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        participant = Participant.objects.create(
            user=request.user,
            giveaway=giveaway
        )
        
        return Response(
            {'message': '–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ!'},
            status=status.HTTP_201_CREATED
        )
    
    @action(detail=True, methods=['post'])
    def draw_winner(self, request, pk=None):
        """–ó–∞–ø—É—Å–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞)"""
        giveaway = self.get_object()
        
        if giveaway.created_by != request.user:
            return Response(
                {'error': '–¢–æ–ª—å–∫–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à'}, 
                status=status.HTTP_403_FORBIDDEN
            )
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
        schedule_giveaway_draw.delay(giveaway.id)
        
        return Response(
            {'message': '–†–æ–∑—ã–≥—Ä—ã—à –∑–∞–ø—É—â–µ–Ω, –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏ –±—É–¥—É—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è'},
            status=status.HTTP_200_OK
        )
    
    @action(detail=True, methods=['get'])
    def participants(self, request, pk=None):
        """–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞"""
        giveaway = self.get_object()
        participants = giveaway.participants.all()
        serializer = ParticipantSerializer(participants, many=True)
        return Response(serializer.data)
    
    @action(detail=True, methods=['get'])
    def winners(self, request, pk=None):
        """–°–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —Ä–æ–∑—ã–≥—Ä—ã—à–∞"""
        giveaway = self.get_object()
        winners = giveaway.winners.all()
        serializer = WinnerSerializer(winners, many=True)
        return Response(serializer.data)

class MyParticipationsViewSet(viewsets.ReadOnlyModelViewSet):
    """–†–æ–∑—ã–≥—Ä—ã—à–∏, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —É—á–∞—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"""
    serializer_class = GiveawaySerializer
    permission_classes = [IsAuthenticated]
    
    # –î–û–ë–ê–í–¨–¢–ï –ò –ó–î–ï–°–¨:
    queryset = Giveaway.objects.all()
    
    def get_queryset(self):
        return Giveaway.objects.filter(
            participants__user=self.request.user
        )

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üöÄ –§–ê–ô–õ: manage.py
----------------------------------------
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê:
------------------------------
‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: 11
‚Ä¢ –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ Django —Ñ–∞–π–ª–æ–≤: 12
‚Ä¢ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π: 1
‚Ä¢ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è: main\
